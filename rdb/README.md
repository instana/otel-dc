# Data Collector for Relational Database


## Requirements

- Java 8+

Ensure that Java SDK 11+ is installed.
```bash
java -version
```


## Run Data Collector with release (for end users)
Download the latest  [Release package](https://github.com/instana/otel-dc/releases/tag/Release) according to the operating system.


1) Download the installation package:
```bash
wget https://github.com/instana/otel-dc/releases/download/v1.0.10/otel-dc-rdb-0.5.5.tar
```

2) Extract the package to the desired deployment location:
```bash
tar vxf otel-dc-rdb-0.5.5.tar
cd otel-dc-rdb-0.5.5
```

3) Make sure following configuration files are correct for your environment:
  - config/config.yaml
  - config/logging.properties

Refine configuration file (config/config.yaml) according to your own database. Right now we provide Data Collector for following databases:
  - DaMeng database
  - Oceanbase
  - Informix
*Note:* The default configuration file config/config.yaml is for Dameng DB. If you want to monitor an Informix DB, you can copy config/config-informix.yaml to config/config.yaml, or you can also use environment variable "DC_CONFIG" to specify the configuration file, for example:
```bash
export DC_CONFIG=config/config-informix.yaml
```

Notes for some parameters：
- `otel.backend.url`：The OTel gRPC address of the OTel backends, for example Instana Agent (as OTel Backend): http://localhost:4317
- `otel.service.name`：The Data Collector name, which can be any string you choose.

4) Run Data Collector
Run the Data Collector with the following command according to your current system:
```bash
nohup ./bin/otel-dc-rdb
```


## Build & Run (for developers)

1) Make sure Java SDK is installed.
```bash
java -version
```

2) Get the source code from `github.com`.
```bash
git clone https://github.com/instana/otel-dc.git
cd otel-dc/rdb
```

3) Build with Gradle
```bash
./gradlew clean build
```
*Note: gradle 7.4 will be installed if you do not have it.*

4) Make sure following configuration files are correct for your environment:
  - config/config.yaml
  - config/logging.properties

Refine configuration file (config/config.yaml) according to your own database. Right now we provide Data Collector for following databases:
  - DaMeng database
  - Oceanbase
  - Informix
*Note:* The default configuration file config/config.yaml is for Dameng DB. If you want to monitor an Informix DB, you can copy config/config-informix.yaml to config/config.yaml, or you can also use environment variable "DC_CONFIG" to specify the configuration file, for example:
```bash
export DC_CONFIG=config/config-informix.yaml
```

5) Start up your OTLP backend which accept OTLP connections. Right now we support following protocols:
- otlp/grpc
- otlp/http

```bash
./gradlew run
```

6) *Appendix:* Run binary in "build/distributions"
Find the deployment package (e.g.:otel-dc-rdb-*.tar/otel-dc-host-*.tar/otel-dc-host-*.tar) generated by gradle in the "build/distributions/" directory, extract deployment files:
```bash
cd build/distributions/
tar vxf otel-dc-rdb-*.tar
rm -f *.tar *.zip
cd otel-dc-rdb-*
```

Modify the configuration files.
Then, make sure following configuration files are correct for your environment.:
  - config/config.yaml
  - config/logging.properties

Run the Data Collector with following command according to your current implentation:
```bash
export DC_CONFIG=config/config.yaml
export JAVA_OPTS=-Dconfig/logging.properties
bin/otel-dc-rdb
```
Or run Data Collector in background
```bash
export DC_CONFIG=config/config.yaml
export JAVA_OPTS=-Dconfig/logging.properties
nohup bin/otel-dc-rdb > /dev/null 2>&1 &
```


*Notes for useful commands:* 

1) Query DataCollector
```bash
ps -ef | grep otel-dc | grep -v grep
```

2) Stop DataCollector
```bash
ps -ef | grep otel-dc | grep -v grep | awk '{printf " "$2" "}' | xargs kill -9
```

3) Check logging file
```bash
ls -l ~/*-dc*.log*
```

## Troubleshooting 
General troubleshooting guide for the Relational Database (RDB).

### Informix DB
If the main script encounters any issues and you want to validate the setup directly on the system, you can use the following script to manually configure the Informix environment.

Copy and execute this script on the system where the Informix database is installed:

```dtd
#!/bin/bash
# Informix Environment Setup Script
# Fill in the values below before running

# === Configuration (Edit these values) ===
DB_PATH=""        # Example: /opt/IBM/Informix_Software_Bundle
SERVER_NAME=""    # Example: ol_informix1410

# Validate inputs
if [ -z "$DB_PATH" ]; then
  echo "Error: Please set DB_PATH in the script before running"
  exit 1
fi

if [ -z "$SERVER_NAME" ]; then
  echo "Error: Please set SERVER_NAME in the script before running"
  exit 1
fi

# Export Informix environment variables
export INFORMIXDIR=$DB_PATH
export ONCONFIG=onconfig.$SERVER_NAME
export INFORMIXSERVER=$SERVER_NAME
export PATH=$INFORMIXDIR/bin:$PATH
export INFORMIXSQLHOSTS=$INFORMIXDIR/etc/sqlhosts.$SERVER_NAME

echo "Informix environment variables set successfully:"
echo "INFORMIXDIR=$INFORMIXDIR"
echo "ONCONFIG=$ONCONFIG"
echo "INFORMIXSERVER=$INFORMIXSERVER"
echo "INFORMIXSQLHOSTS=$INFORMIXSQLHOSTS"
echo "PATH includes $INFORMIXDIR/bin"
echo ""
echo "You can now run the Informix scripts in rdb/scripts/informix/"
```


### Running Informix Scripts

Once the environment variables are set, you can execute any Informix-related script from the configured environment.

Before running a command such as `onstat`, ensure that you are in the directory where the `onstat` binary is located — typically under:``$INFORMIXDIR/bin``

```dtd
#!/bin/bash
result=$(onstat -g his 1 | head -n 10 | awk '{a[NR]=$0} END{print a[NR-1]}' | awk '{print $4}')
echo $result
```

**Notes:**
* The script navigates to the directory containing the onstat command to ensure it executes correctly.

* The awk commands process and extract a specific field from the onstat -g his output for validation or troubleshooting purposes.

* You can modify the command or parsing logic as needed for deeper diagnostics.